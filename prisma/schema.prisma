// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id          String    @id @default(cuid())
  email       String?   @unique
  phone       String?   @unique
  name        String?
  // Client-side salt for key derivation (Base64 encoded)
  clientSalt  String?   
  // Server-side encrypted data
  encryptedProfile String? @db.Text
  profileIv   String?   // IV for profile encryption
  isOnboarded Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  // Relations
  assessments Assessment[]
  messages    ChatMessage[]
  
  @@map("users")
}

model Assessment {
  id                String    @id @default(cuid())
  userId            String
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Encrypted assessment data (name, age, diabetes, BP, etc.)
  encryptedData     String    @db.Text // Base64 encoded encrypted data
  encryptionIv      String    // Base64 encoded IV for this encryptedData
  
  // Metadata (not encrypted)
  submissionType    String    @default("assessment") // assessment, follow-up, etc.
  isCompleted       Boolean   @default(true)
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@map("assessments")
}

model ChatMessage {
  id                String    @id @default(cuid())
  userId            String
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  sender            String    // 'user' or 'ai'
  messageType       String    @default("text") // text, image, card, etc.
  
  // Encrypted message content
  encryptedContent  String    @db.Text // Base64 encoded encrypted content
  encryptionIv      String    // Base64 encoded IV
  
  // Metadata (not encrypted)
  isSystemMessage   Boolean   @default(false)
  parentMessageId   String?   // For threading/replies
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@map("chat_messages")
}

model EncryptionAuditLog {
  id                String    @id @default(cuid())
  userId            String?   // Optional - for system-wide events
  
  operation         String    // encrypt, decrypt, key_derivation, etc.
  dataType          String    // assessment, message, profile, etc.
  success           Boolean
  errorMessage      String?
  
  // Performance metrics
  processingTimeMs  Float?
  dataSize          Int?      // Size in bytes
  
  // Security metadata
  algorithm         String?   // AES-256-GCM, PBKDF2, etc.
  keyDerivationTime Float?    // For key derivation operations
  
  ipAddress         String?
  userAgent         String?
  
  createdAt         DateTime  @default(now())
  
  @@map("encryption_audit_logs")
}

model SystemConfig {
  id                String    @id @default(cuid())
  key               String    @unique
  value             String    @db.Text
  description       String?
  isEncrypted       Boolean   @default(false)
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@map("system_config")
}